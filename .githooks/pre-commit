#!/bin/bash

# AIKit Pre-commit Hook
# Run basic quality checks before committing

set -e

echo "ğŸ” Running pre-commit checks..."
echo "==============================="

# Check if we're in the right directory
if [ ! -f "Cargo.toml" ]; then
    echo "Error: Run this script from the project root (aikit directory)"
    exit 1
fi

# Block Rust .rcgu.o artifacts outside target/
staged_rcgu=$(git diff --cached --name-only 2>/dev/null | grep '\.rcgu\.o$' || true)
if [ -n "$staged_rcgu" ]; then
  bad=""
  for f in $staged_rcgu; do
    case "$f" in target/*) ;; *) bad="$bad $f";; esac
  done
  if [ -n "$bad" ]; then
    echo "Error: Rust .rcgu.o artifacts must not be committed outside target/:$bad"
    exit 1
  fi
fi

echo "Repository structure verified"

# Check code formatting
echo ""
echo "ğŸ“ Checking code formatting..."
if cargo fmt --check; then
    echo "âœ… Code formatting is correct"
else
    echo "âŒ Code formatting issues found. Run 'cargo fmt' to fix."
    exit 1
fi

# Run clippy linting
echo ""
echo "ğŸ”§ Running clippy linting..."
if cargo clippy -- -D warnings; then
    echo "âœ… Clippy checks passed"
else
    echo "âŒ Clippy found issues. Fix the warnings before committing."
    exit 1
fi

# Run quick unit tests
echo ""
echo "ğŸ§ª Running unit tests..."
if cargo test --lib --quiet -- --test-threads=1; then
    echo "âœ… Unit tests passed"
else
    echo "âŒ Unit tests failed. Fix the issues before committing."
    exit 1
fi

echo ""
echo "ğŸ‰ All pre-commit checks passed!"
echo ""

exit 0
exit 0

