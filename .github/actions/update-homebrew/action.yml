name: 'Update Homebrew Formula'
description: 'Update Homebrew formula with new version and binary URLs/hashes'
inputs:
  version:
    description: 'New version to update to'
    required: true
  linux_gnu_url:
    description: 'URL for Linux GNU binary'
    required: true
  linux_gnu_hash:
    description: 'SHA256 hash for Linux GNU binary'
    required: true
  linux_musl_url:
    description: 'URL for Linux MUSL binary'
    required: true
  linux_musl_hash:
    description: 'SHA256 hash for Linux MUSL binary'
    required: true
  gh_token:
    description: 'GitHub token for git operations'
    required: true
  formula_path:
    description: 'Path to the formula file'
    required: false
    default: 'Formula/aikit.rb'
  formula_name:
    description: 'Name of the formula'
    required: false
    default: 'aikit'
  repo_path:
    description: 'Path where homebrew repo is checked out'
    required: false
    default: 'homebrew-cli'
  config_file:
    description: 'Path to release config file'
    required: false
    default: '.github/release-config.yml'
runs:
  using: 'composite'
  steps:
    - name: Update Homebrew formula
      shell: bash
      run: |
        # Read config for repository and formula paths, with fallbacks
        HOMEBREW_REPO="${{ inputs.repo_path }}"
        FORMULA_PATH="${{ inputs.formula_path }}"
        FORMULA_NAME="${{ inputs.formula_name }}"

        if [ -f "${{ inputs.config_file }}" ]; then
          # Try to parse config - for now use defaults
          echo "Using config defaults for Homebrew"
        fi

        if [ ! -d "$HOMEBREW_REPO" ]; then
          echo "⚠️  $HOMEBREW_REPO repository not checked out, skipping Homebrew update"
          exit 0
        fi

        echo "Updating Homebrew formula to version ${{ inputs.version }}"

        cd $HOMEBREW_REPO

        # Use Python for reliable URL/hash replacement that handles "null" values
        python3 << PYTHON_SCRIPT
import re
import sys

formula_path = "${{ inputs.formula_path }}"
version = "${{ inputs.version }}"
gnu_url = "${{ inputs.linux_gnu_url }}"
gnu_hash = "${{ inputs.linux_gnu_hash }}"
musl_url = "${{ inputs.linux_musl_url }}"
musl_hash = "${{ inputs.linux_musl_hash }}"

with open(formula_path, 'r') as f:
    content = f.read()

# Update version
content = re.sub(r'version ".*"', f'version "{version}"', content)

# Update GNU URL and hash (in the "if glibc_version >= 2.38" block)
# Match any URL value (including "null") followed by sha256 in the GNU block
gnu_pattern = r'(if glibc_version >= 2\.38\s*\n\s+url ")([^"]+)("\s*\n\s+sha256 ")([^"]+)(")'
content = re.sub(gnu_pattern, rf'\1{gnu_url}\3{gnu_hash}\5', content, flags=re.MULTILINE)

# Update MUSL URL and hash (in the "else" block)
# Match any URL value (including "null") followed by sha256 in the else block
musl_pattern = r'(else\s*\n\s+url ")([^"]+)("\s*\n\s+sha256 ")([^"]+)(")'
content = re.sub(musl_pattern, rf'\1{musl_url}\3{musl_hash}\5', content, flags=re.MULTILINE)

with open(formula_path, 'w') as f:
    f.write(content)

print("Homebrew formula updated successfully")
PYTHON_SCRIPT

        echo "Homebrew formula updated"

    - name: Validate Homebrew formula
      shell: bash
      run: |
        if [ ! -d "${{ inputs.repo_path }}" ]; then
          echo "⚠️  ${{ inputs.repo_path }} repository not checked out, skipping validation"
          exit 0
        fi

        echo "Validating Homebrew formula..."
        cd ${{ inputs.repo_path }}
        brew audit --strict ${{ inputs.formula_path }} || echo "Warning: Formula validation failed, but continuing..."

    - name: Commit and push Homebrew changes
      shell: bash
      run: |
        if [ ! -d "${{ inputs.repo_path }}" ]; then
          echo "❌ ${{ inputs.repo_path }} repository not checked out"
          exit 1
        fi

        cd ${{ inputs.repo_path }}
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Configure git to use token
        git remote set-url origin https://${{ inputs.gh_token }}@github.com/goaikit/homebrew-cli.git

        if git diff --quiet; then
          echo "No changes to commit for Homebrew"
        else
          git add ${{ inputs.formula_path }}
          git commit -m "Update ${{ inputs.formula_name }} to version ${{ inputs.version }}"
          git push origin HEAD:refs/heads/main

          # Verify push succeeded
          if [ $? -ne 0 ]; then
            echo "❌ Failed to push Homebrew changes"
            exit 1
          fi
          echo "✅ Homebrew formula updated and pushed"
        fi
      env:
        GH_TOKEN: ${{ inputs.gh_token }}
